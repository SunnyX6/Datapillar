<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.job.server.mapper.JobInfoMapper">

    <resultMap id="BaseResultMap" type="com.sunny.job.server.entity.JobInfo">
        <id column="id" property="id"/>
        <result column="workflow_id" property="workflowId"/>
        <result column="namespace_id" property="namespaceId"/>
        <result column="job_name" property="jobName"/>
        <result column="job_type" property="jobType"/>
        <result column="job_params" property="jobParams"/>
        <result column="route_strategy" property="routeStrategy"/>
        <result column="block_strategy" property="blockStrategy"/>
        <result column="timeout_seconds" property="timeoutSeconds"/>
        <result column="max_retry_times" property="maxRetryTimes"/>
        <result column="retry_interval" property="retryInterval"/>
        <result column="priority" property="priority"/>
        <result column="trigger_type" property="triggerType"/>
        <result column="trigger_value" property="triggerValue"/>
        <result column="position_x" property="positionX"/>
        <result column="position_y" property="positionY"/>
        <result column="description" property="description"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, workflow_id, namespace_id, job_name, job_type, job_params,
        route_strategy, block_strategy, timeout_seconds, max_retry_times,
        retry_interval, priority, trigger_type, trigger_value,
        position_x, position_y, description, is_deleted
    </sql>

    <!-- 查询工作流下所有任务 -->
    <select id="selectByWorkflowId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM job_info
        WHERE workflow_id = #{workflowId}
          AND is_deleted = 0
        ORDER BY id ASC
    </select>

    <!-- 查询工作流下所有任务ID -->
    <select id="selectJobIdsByWorkflowId" resultType="java.lang.Long">
        SELECT id
        FROM job_info
        WHERE workflow_id = #{workflowId}
          AND is_deleted = 0
    </select>

    <!-- 根据ID和工作流ID查询任务 -->
    <select id="selectByIdAndWorkflowId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM job_info
        WHERE id = #{id}
          AND workflow_id = #{workflowId}
          AND is_deleted = 0
    </select>

    <!-- 逻辑删除工作流下所有任务 -->
    <update id="softDeleteByWorkflowId">
        UPDATE job_info
        SET is_deleted = 1
        WHERE workflow_id = #{workflowId}
    </update>

    <!-- 删除任务 -->
    <delete id="deleteByIdAndWorkflowId">
        DELETE FROM job_info
        WHERE id = #{id}
          AND workflow_id = #{workflowId}
    </delete>

    <!-- 更新任务位置 -->
    <update id="updatePosition">
        UPDATE job_info
        SET position_x = #{positionX},
            position_y = #{positionY}
        WHERE id = #{id}
          AND workflow_id = #{workflowId}
    </update>

    <!-- 更新任务信息 -->
    <update id="updateJob">
        UPDATE job_info
        <set>
            <if test="job.jobName != null">job_name = #{job.jobName},</if>
            <if test="job.jobType != null">job_type = #{job.jobType},</if>
            <if test="job.jobParams != null">job_params = #{job.jobParams},</if>
            <if test="job.routeStrategy != null">route_strategy = #{job.routeStrategy},</if>
            <if test="job.blockStrategy != null">block_strategy = #{job.blockStrategy},</if>
            <if test="job.timeoutSeconds != null">timeout_seconds = #{job.timeoutSeconds},</if>
            <if test="job.maxRetryTimes != null">max_retry_times = #{job.maxRetryTimes},</if>
            <if test="job.retryInterval != null">retry_interval = #{job.retryInterval},</if>
            <if test="job.priority != null">priority = #{job.priority},</if>
            <if test="job.triggerType != null">trigger_type = #{job.triggerType},</if>
            <if test="job.triggerValue != null">trigger_value = #{job.triggerValue},</if>
            <if test="job.description != null">description = #{job.description},</if>
        </set>
        WHERE id = #{job.id}
    </update>

</mapper>
