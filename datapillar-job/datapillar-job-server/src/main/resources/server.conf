# Pekko 集群配置（Server 端）
# @author SunnyX6
# @date 2025-12-15
#
# Server 角色：
# - 加入 Worker 集群
# - 只做 CRDT 广播，不参与调度
# - 广播工作流上线/下线事件

pekko {
  loglevel = "INFO"
  loggers = ["org.apache.pekko.event.slf4j.Slf4jLogger"]
  logging-filter = "org.apache.pekko.event.slf4j.Slf4jLoggingFilter"

  actor {
    provider = "cluster"

    # Protobuf 序列化配置（与 Worker 保持一致，确保集群兼容性）
    serializers {
      scheduler-message-serializer = "com.sunny.job.core.serializer.SchedulerMessageSerializer"
      executor-message-serializer = "com.sunny.job.core.serializer.ExecutorMessageSerializer"
      job-run-info-serializer = "com.sunny.job.core.serializer.JobRunInfoSerializer"
    }

    serialization-bindings {
      "com.sunny.job.core.message.SchedulerMessage" = scheduler-message-serializer
      "com.sunny.job.core.message.ExecutorMessage" = executor-message-serializer
      "com.sunny.job.core.message.JobRunInfo" = job-run-info-serializer
      "com.sunny.job.core.message.WorkflowBroadcast" = jackson-json
    }

  }

  remote {
    artery {
      canonical {
        hostname = "127.0.0.1"
        hostname = ${?PEKKO_HOST}
        # Server 使用不同端口，避免与 Worker 冲突
        port = 2550
        port = ${?PEKKO_PORT}
      }
    }
  }

  cluster {
    # 与 Worker 使用相同的 seed-nodes
    seed-nodes = [
      "pekko://datapillar-job@127.0.0.1:2551"
    ]
    seed-nodes = ${?PEKKO_SEED_NODES}

    downing-provider-class = "org.apache.pekko.cluster.sbr.SplitBrainResolverProvider"

    # Server 角色标识
    roles = ["server"]

    # seed node 重启后自动重连
    shutdown-after-unsuccessful-join-seed-nodes = off
    retry-unsuccessful-join-after = 1s
    seed-node-timeout = 5s
  }

  # Distributed Data 配置（用于 CRDT 广播）
  cluster.distributed-data {
    gossip-interval = 500ms
    notify-subscribers-interval = 200ms
    max-delta-elements = 500
  }
}
