# Pekko 集群配置
# @author SunnyX6
# @date 2025-12-13
#
# 去中心化 + 本地化架构：
# - 每个 Worker 有一个本地 JobScheduler
# - 通过 CRDT (Bucket) 实现任务分片
# - 任务在 Virtual Thread Dispatcher 执行
# - 不使用 Cluster Singleton 和 Cluster Sharding

pekko {
  loglevel = "INFO"
  loggers = ["org.apache.pekko.event.slf4j.Slf4jLogger"]
  logging-filter = "org.apache.pekko.event.slf4j.Slf4jLoggingFilter"

  actor {
    provider = "cluster"

    # Protobuf 序列化配置（替代 Jackson JSON，性能提升 5-10 倍）
    serializers {
      scheduler-message-serializer = "com.sunny.job.worker.pekko.serializer.SchedulerMessageSerializer"
      executor-message-serializer = "com.sunny.job.worker.pekko.serializer.ExecutorMessageSerializer"
      job-run-info-serializer = "com.sunny.job.worker.pekko.serializer.JobRunInfoSerializer"
    }

    serialization-bindings {
      "com.sunny.job.core.message.SchedulerMessage" = scheduler-message-serializer
      "com.sunny.job.core.message.ExecutorMessage" = executor-message-serializer
      "com.sunny.job.core.message.JobRunInfo" = job-run-info-serializer
    }

    # JobScheduler Dispatcher - 使用 Fork-Join（调度决策，轻量操作）
    # 并行度说明：
    # - parallelism-min: 最小线程数，保证基本并发能力
    # - parallelism-factor: 线程数 = CPU 核心数 * factor
    # - parallelism-max: 最大线程数，在高核心服务器上需要足够大
    job-scheduler-dispatcher {
      type = Dispatcher
      executor = "fork-join-executor"
      fork-join-executor {
        parallelism-min = 4
        parallelism-factor = 2.0
        parallelism-max = 64
      }
      throughput = 100
    }

    # JobExecutor Dispatcher - 使用 Fork-Join（任务执行）
    job-executor-dispatcher {
      type = Dispatcher
      executor = "fork-join-executor"
      fork-join-executor {
        parallelism-min = 8
        parallelism-factor = 4.0
        parallelism-max = 128
      }
      throughput = 20
    }
  }

  remote {
    artery {
      canonical {
        hostname = "127.0.0.1"
        hostname = ${?PEKKO_HOST}
        port = 2551
        port = ${?PEKKO_PORT}
      }
    }
  }

  cluster {
    seed-nodes = [
      "pekko://datapillar-job@127.0.0.1:2551"
    ]
    seed-nodes = ${?PEKKO_SEED_NODES}

    downing-provider-class = "org.apache.pekko.cluster.sbr.SplitBrainResolverProvider"
  }

  # Distributed Data 配置 (仅用于 Bucket 所有权管理)
  # 高 TPS 场景优化：降低 gossip 间隔，加快状态同步
  cluster.distributed-data {
    gossip-interval = 500ms
    notify-subscribers-interval = 200ms
    # 增加并行度，提升同步吞吐
    max-delta-elements = 500
  }
}
