<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.job.worker.domain.mapper.JobRunMapper">

    <!-- JobRunInfo 结果映射（不含 job_info 字段，需要从缓存补全） -->
    <resultMap id="jobRunInfoMap" type="com.sunny.job.core.message.JobRunInfo">
        <result column="job_run_id" property="jobRunId"/>
        <result column="workflow_run_id" property="workflowRunId"/>
        <result column="workflow_id" property="workflowId"/>
        <result column="job_id" property="jobId"/>
        <result column="bucket_id" property="bucketId"/>
        <result column="namespace_id" property="namespaceId"/>
        <result column="trigger_time" property="triggerTime"/>
        <result column="retry_count" property="retryCount"/>
        <result column="priority" property="priority"/>
        <result column="status" property="status"/>
    </resultMap>

    <!-- 基础查询列（只查 job_run 表，消除 JOIN） -->
    <sql id="baseColumns">
        id AS job_run_id,
        workflow_run_id,
        workflow_id,
        job_id,
        bucket_id,
        namespace_id,
        trigger_time,
        retry_count,
        priority,
        status
    </sql>

    <!-- 按 Bucket 查询待执行的任务（带分页） -->
    <select id="selectWaitingJobsByBuckets" resultMap="jobRunInfoMap">
        SELECT
            <include refid="baseColumns"/>
        FROM job_run
        WHERE status = 0
        AND is_deleted=0
        AND bucket_id IN
        <foreach collection="bucketIds" item="bucketId" open="(" separator="," close=")">
            #{bucketId}
        </foreach>
        ORDER BY trigger_time ASC, priority DESC
        LIMIT #{limit}
    </select>

    <!-- 按单个 Bucket 查询待执行的任务（带分页） -->
    <select id="selectWaitingJobsByBucket" resultMap="jobRunInfoMap">
        SELECT
            <include refid="baseColumns"/>
        FROM job_run
        WHERE status = 0
        AND is_deleted=0
        AND bucket_id = #{bucketId}
        ORDER BY trigger_time ASC, priority DESC
        LIMIT #{limit}
    </select>

    <!-- 按 Bucket 查询新增的任务（带分页） -->
    <select id="selectNewJobsByBuckets" resultMap="jobRunInfoMap">
        SELECT
            <include refid="baseColumns"/>
        FROM job_run
        WHERE id > #{lastMaxId}
        AND is_deleted=0
        AND status = 0
        AND bucket_id IN
        <foreach collection="bucketIds" item="bucketId" open="(" separator="," close=")">
            #{bucketId}
        </foreach>
        ORDER BY trigger_time ASC, priority DESC
        LIMIT #{limit}
    </select>

    <!-- 查询被重跑的任务 -->
    <select id="selectRerunJobs" resultMap="jobRunInfoMap">
        SELECT
            <include refid="baseColumns"/>
        FROM job_run
        WHERE id IN
        <foreach collection="jobRunIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND status = 0
        AND is_deleted=0
    </select>

    <!-- 查询当前需要执行的最大jobRunID（使用主键索引） -->
    <select id="selectMaxId" resultType="java.lang.Long">
        SELECT id FROM job_run where status=0 AND is_deleted=0 ORDER BY id DESC LIMIT 1
    </select>

    <!-- 查询工作流下所有任务的状态 -->
    <select id="selectStatusByWorkflowRunId" resultType="java.lang.Integer">
        SELECT status
        FROM job_run
        WHERE workflow_run_id = #{workflowRunId}
        AND is_deleted=0
    </select>

    <!-- 更新任务状态 -->
    <update id="updateStatus">
        UPDATE job_run
        <set>
            status = #{status},
            <if test="op != null">
                op = #{op},
            </if>
            worker_address = #{workerId},
            <if test="startTime != null">
                start_time = #{startTime},
            </if>
            <if test="endTime != null">
                end_time = #{endTime},
            </if>
            <if test="message != null">
                result_message = #{message},
            </if>
            updated_at = NOW(3)
        </set>
        WHERE id = #{jobRunId}
        AND is_deleted=0
    </update>

    <!-- 更新任务为重试状态 -->
    <update id="updateForRetry">
        UPDATE job_run
        <set>
            status = 0,
            <if test="op != null">
                op = #{op},
            </if>
            retry_count = #{retryCount},
            updated_at = NOW(3)
        </set>
        WHERE id = #{jobRunId}
        AND is_deleted=0
    </update>

    <!-- 批量插入任务执行实例（支持手动指定 ID） -->
    <insert id="batchInsert">
        INSERT INTO job_run (id, namespace_id, workflow_run_id, workflow_id, job_id, bucket_id, trigger_type, trigger_time, status, priority, retry_count, op)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.id}, #{item.namespaceId}, #{item.workflowRunId}, #{item.workflowId}, #{item.jobId}, #{item.bucketId}, #{item.triggerType}, #{item.triggerTime}, #{item.status}, #{item.priority}, #{item.retryCount}, #{item.op})
        </foreach>
    </insert>

    <!-- 根据 jobRunId 查询 bucketId -->
    <select id="selectBucketIdById" resultType="java.lang.Integer">
        SELECT bucket_id FROM job_run WHERE id = #{jobRunId} AND is_deleted = 0
    </select>

    <!-- 按 workflowRunId 和 bucketIds 查询 job_run -->
    <select id="selectByWorkflowRunIdAndBuckets" resultMap="jobRunInfoMap">
        SELECT
            <include refid="baseColumns"/>
        FROM job_run
        WHERE workflow_run_id = #{workflowRunId}
        AND is_deleted = 0
        AND bucket_id IN
        <foreach collection="bucketIds" item="bucketId" open="(" separator="," close=")">
            #{bucketId}
        </foreach>
    </select>

    <!-- 批量更新状态为 WAITING（重跑用） -->
    <update id="batchUpdateStatusToWaiting">
        UPDATE job_run
        SET status = 0, op = #{op}, updated_at = NOW(3)
        WHERE id IN
        <foreach collection="jobRunIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- 批量更新状态为 CANCELLED（下线/取消用） -->
    <update id="batchUpdateStatusToCancelled">
        UPDATE job_run
        SET status = 6, op = #{op}, updated_at = NOW(3)
        WHERE id IN
        <foreach collection="jobRunIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- 按时间窗口查询任务（预加载优化） -->
    <!-- 使用索引：idx_bucket_status_trigger (bucket_id, status, trigger_time) -->
    <!-- 查询所有 trigger_time <= windowEnd 的 WAITING 任务，包含已过期但未执行的 -->
    <select id="selectJobsInTimeWindow" resultMap="jobRunInfoMap">
        SELECT
            <include refid="baseColumns"/>
        FROM job_run
        WHERE status = #{status}
        AND bucket_id IN
        <foreach collection="bucketIds" item="bucketId" open="(" separator="," close=")">
            #{bucketId}
        </foreach>
        AND trigger_time &lt;= #{windowEnd}
        AND is_deleted=0
        ORDER BY trigger_time ASC, priority DESC
        LIMIT #{limit}
    </select>

</mapper>
