<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.job.worker.domain.mapper.JobRunMapper">

    <!-- JobRunInfo 结果映射（不含 job_info 字段，需要从缓存补全） -->
    <resultMap id="jobRunInfoMap" type="com.sunny.job.core.message.JobRunInfo">
        <result column="job_run_id" property="jobRunId"/>
        <result column="workflow_run_id" property="workflowRunId"/>
        <result column="job_id" property="jobId"/>
        <result column="bucket_id" property="bucketId"/>
        <result column="namespace_id" property="namespaceId"/>
        <result column="trigger_time" property="triggerTime"/>
        <result column="retry_count" property="retryCount"/>
        <result column="priority" property="priority"/>
        <result column="status" property="status"/>
    </resultMap>

    <!-- 基础查询列（只查 job_run 表，消除 JOIN） -->
    <sql id="baseColumns">
        id AS job_run_id,
        workflow_run_id,
        job_id,
        bucket_id,
        namespace_id,
        trigger_time,
        retry_count,
        priority,
        status
    </sql>

    <!-- 按 Bucket 查询待执行的任务（带分页） -->
    <select id="selectWaitingJobsByBuckets" resultMap="jobRunInfoMap">
        SELECT
            <include refid="baseColumns"/>
        FROM job_run
        WHERE status = 0
        AND bucket_id IN
        <foreach collection="bucketIds" item="bucketId" open="(" separator="," close=")">
            #{bucketId}
        </foreach>
        ORDER BY trigger_time ASC, priority DESC
        LIMIT #{limit}
    </select>

    <!-- 按单个 Bucket 查询待执行的任务（带分页） -->
    <select id="selectWaitingJobsByBucket" resultMap="jobRunInfoMap">
        SELECT
            <include refid="baseColumns"/>
        FROM job_run
        WHERE status = 0
        AND bucket_id = #{bucketId}
        ORDER BY trigger_time ASC, priority DESC
        LIMIT #{limit}
    </select>

    <!-- 按 Bucket 查询新增的任务（带分页） -->
    <select id="selectNewJobsByBuckets" resultMap="jobRunInfoMap">
        SELECT
            <include refid="baseColumns"/>
        FROM job_run
        WHERE id > #{lastMaxId}
        AND status = 0
        AND bucket_id IN
        <foreach collection="bucketIds" item="bucketId" open="(" separator="," close=")">
            #{bucketId}
        </foreach>
        ORDER BY trigger_time ASC, priority DESC
        LIMIT #{limit}
    </select>

    <!-- 查询被重跑的任务 -->
    <select id="selectRerunJobs" resultMap="jobRunInfoMap">
        SELECT
            <include refid="baseColumns"/>
        FROM job_run
        WHERE id IN
        <foreach collection="jobRunIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND status = 0
    </select>

    <!-- 查询当前最大ID（使用主键索引） -->
    <select id="selectMaxId" resultType="java.lang.Long">
        SELECT id FROM job_run ORDER BY id DESC LIMIT 1
    </select>

    <!-- 查询工作流下所有任务的状态 -->
    <select id="selectStatusByWorkflowRunId" resultType="java.lang.Integer">
        SELECT status
        FROM job_run
        WHERE workflow_run_id = #{workflowRunId}
    </select>

    <!-- 更新任务状态 -->
    <update id="updateStatus">
        UPDATE job_run
        SET status = #{status},
            worker_address = #{workerId},
            start_time = #{startTime},
            end_time = #{endTime},
            result_message = #{message},
            updated_at = NOW(3)
        WHERE id = #{jobRunId}
    </update>

    <!-- 更新任务为重试状态 -->
    <update id="updateForRetry">
        UPDATE job_run
        SET status = 0,
            retry_count = #{retryCount},
            updated_at = NOW(3)
        WHERE id = #{jobRunId}
    </update>

    <!-- 批量插入任务执行实例 -->
    <insert id="batchInsert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO job_run (namespace_id, workflow_run_id, job_id, bucket_id, trigger_type, trigger_time, status, priority)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.namespaceId}, #{item.workflowRunId}, #{item.jobId}, #{item.bucketId}, #{item.triggerType}, #{item.triggerTime}, #{item.status}, #{item.priority})
        </foreach>
    </insert>

    <!-- 按时间窗口查询任务（预加载优化） -->
    <!-- 使用索引：idx_bucket_status_trigger (bucket_id, status, trigger_time) -->
    <select id="selectJobsInTimeWindow" resultMap="jobRunInfoMap">
        SELECT
            <include refid="baseColumns"/>
        FROM job_run
        WHERE status = #{status}
        AND bucket_id IN
        <foreach collection="bucketIds" item="bucketId" open="(" separator="," close=")">
            #{bucketId}
        </foreach>
        AND trigger_time BETWEEN #{windowStart} AND #{windowEnd}
        ORDER BY trigger_time ASC, priority DESC
        LIMIT #{limit}
    </select>

    <!-- 批量更新任务状态（使用 CASE WHEN 单条 SQL，避免多次网络往返） -->
    <update id="batchUpdateStatus">
        UPDATE job_run
        SET
            status = CASE id
                <foreach collection="list" item="item">
                    WHEN #{item.jobRunId} THEN #{item.status}
                </foreach>
            END,
            worker_address = CASE id
                <foreach collection="list" item="item">
                    WHEN #{item.jobRunId} THEN #{item.workerId}
                </foreach>
            END,
            start_time = CASE id
                <foreach collection="list" item="item">
                    WHEN #{item.jobRunId} THEN #{item.startTime}
                </foreach>
            END,
            end_time = CASE id
                <foreach collection="list" item="item">
                    WHEN #{item.jobRunId} THEN #{item.endTime}
                </foreach>
            END,
            result_message = CASE id
                <foreach collection="list" item="item">
                    WHEN #{item.jobRunId} THEN #{item.message}
                </foreach>
            END,
            updated_at = NOW(3)
        WHERE id IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.jobRunId}
        </foreach>
    </update>

</mapper>
