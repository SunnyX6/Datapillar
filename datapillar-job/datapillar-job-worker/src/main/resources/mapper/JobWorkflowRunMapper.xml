<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.job.worker.domain.mapper.JobWorkflowRunMapper">

    <!-- 插入工作流执行实例（支持手动指定 ID） -->
    <insert id="insert">
        INSERT INTO job_workflow_run (id, namespace_id, workflow_id, trigger_type, trigger_time, status, op)
        VALUES (#{id}, #{namespaceId}, #{workflowId}, #{triggerType}, #{triggerTime}, #{status}, #{op})
    </insert>

    <!-- 根据 ID 查询工作流执行实例 -->
    <select id="selectById" resultType="com.sunny.job.worker.domain.entity.JobWorkflowRun">
        SELECT id, namespace_id AS namespaceId, workflow_id AS workflowId,
               trigger_type AS triggerType, trigger_time AS triggerTime,
               next_trigger_time AS nextTriggerTime, status
        FROM job_workflow_run
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <!-- 更新工作流执行实例状态 -->
    <update id="updateStatus">
        UPDATE job_workflow_run
        <set>
            status = #{status},
            <if test="op != null">
                op = #{op},
            </if>
            end_time = #{endTime},
            result_message = #{message},
            updated_at = NOW(3)
        </set>
        WHERE id = #{workflowRunId} AND is_deleted = 0
    </update>

    <!-- CAS 更新状态和 nextTriggerTime -->
    <update id="updateStatusAndNextTriggerTime">
        UPDATE job_workflow_run
        SET status = #{newStatus},
            start_time = #{startTime},
            next_trigger_time = #{nextTriggerTime},
            updated_at = NOW(3)
        WHERE id = #{workflowRunId}
          AND status = #{expectedStatus}
          AND is_deleted = 0
    </update>

    <!-- 查询工作流执行实例的工作流ID -->
    <select id="selectWorkflowIdByRunId" resultType="java.lang.Long">
        SELECT workflow_id FROM job_workflow_run WHERE id = #{workflowRunId} AND is_deleted = 0
    </select>

    <!-- 查询状态为 RUNNING 且 nextTriggerTime 有值的 workflow_run -->
    <select id="selectRunningWithNextTriggerTime" resultType="com.sunny.job.worker.domain.entity.JobWorkflowRun">
        SELECT id, namespace_id AS namespaceId, workflow_id AS workflowId,
               trigger_type AS triggerType, trigger_time AS triggerTime,
               next_trigger_time AS nextTriggerTime, status
        FROM job_workflow_run
        WHERE status = 1
          AND next_trigger_time IS NOT NULL
          AND next_trigger_time > 0
          AND is_deleted = 0
    </select>

    <!-- 检查是否已存在指定 workflowId 和 triggerTime 的 workflow_run -->
    <select id="existsByWorkflowIdAndTriggerTime" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM job_workflow_run
        WHERE workflow_id = #{workflowId}
          AND trigger_time = #{triggerTime}
          AND is_deleted = 0
    </select>

</mapper>
