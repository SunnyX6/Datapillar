<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.job.worker.domain.mapper.JobDependencyMapper">

    <!-- 查询任务的上游依赖（执行阶段） -->
    <select id="selectParentRunIds" resultType="java.lang.Long">
        SELECT parent_run_id
        FROM job_run_dependency
        WHERE job_run_id = #{jobRunId}
    </select>

    <!-- 批量查询多个任务的上游依赖（优化 N+1 查询） -->
    <select id="selectParentRunIdsBatch" resultType="com.sunny.job.worker.domain.entity.JobRunDependency">
        SELECT job_run_id AS jobRunId, parent_run_id AS parentRunId
        FROM job_run_dependency
        WHERE job_run_id IN
        <foreach collection="jobRunIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- 查询工作流下所有任务依赖关系（设计阶段） -->
    <select id="selectByWorkflowId" resultType="com.sunny.job.worker.domain.entity.JobDependency">
        SELECT
            job_id AS jobId,
            parent_job_id AS parentJobId
        FROM job_dependency
        WHERE workflow_id = #{workflowId}
    </select>

    <!-- 批量插入任务执行依赖关系 -->
    <insert id="batchInsertRunDependencies">
        INSERT INTO job_run_dependency (workflow_run_id, job_run_id, parent_run_id)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.workflowRunId}, #{item.jobRunId}, #{item.parentRunId})
        </foreach>
    </insert>

</mapper>
