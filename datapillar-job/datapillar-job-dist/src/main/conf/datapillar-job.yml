# =============================================================================
# Datapillar Job 统一配置文件
# =============================================================================
# 本文件包含 Server 和 Worker 的所有配置项
# 部署时只需修改此文件，无需重新打包
#
# @author SunnyX6
# @date 2025-12-14
# =============================================================================

# -----------------------------------------------------------------------------
# 通用配置
# -----------------------------------------------------------------------------
common:
  # 数据库配置
  datasource:
    url: jdbc:mysql://localhost:3306/datapillar?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&rewriteBatchedStatements=true&cachePrepStmts=true&prepStmtCacheSize=250&prepStmtCacheSqlLimit=2048&useServerPrepStmts=true
    username: root
    password: Sunny.123456
    # HikariCP 连接池
    hikari:
      minimum-idle: 10
      maximum-pool-size: 50
      idle-timeout: 60000
      connection-timeout: 10000
      max-lifetime: 1800000

# -----------------------------------------------------------------------------
# Server 配置（API 服务）
# -----------------------------------------------------------------------------
server:
  # 服务端口
  port: 8080

# -----------------------------------------------------------------------------
# Worker 配置（调度执行节点）
# -----------------------------------------------------------------------------
worker:
  # 服务端口
  port: 8081
  # Worker 标识地址（用于集群通信和 DB 记录）
  address: ${HOSTNAME:localhost}
  # 最大并发任务数
  max-concurrent-tasks: 500
  # 最大待调度任务数（内存保护）
  max-pending-tasks: 10000
  # Bucket 总数（任务分片粒度，不建议修改）
  bucket-count: 1024
  # 调度器分片数（0 = 自动使用 CPU 核心数）
  scheduler-shard-count: 0
  # 预加载时间窗口（毫秒）
  preload-window-ms: 5000
  # 每次预加载的最大任务数
  preload-batch-size: 1000
  # 批量写入大小
  batch-write-size: 2000
  # 批量写入阈值
  batch-write-threshold: 5000
  # 任务日志
  log:
    base-path: ../logs/job
    retention-days: 7
  # 缓存配置
  cache:
    job-run-state:
      max-size: 100000
      expire-after-write-minutes: 30
    shard-state:
      max-size: 10000
      expire-after-write-minutes: 60
    split-state:
      max-size: 50000
      expire-after-write-minutes: 60
    worker-state:
      max-size: 1000
      expire-after-write-minutes: 5

# -----------------------------------------------------------------------------
# Pekko 集群配置
# -----------------------------------------------------------------------------
pekko:
  # 本机绑定地址
  host: ${HOSTNAME:127.0.0.1}
  # 集群通信端口
  port: 2551
  # 种子节点列表（生产环境建议配置 3 个以上）
  # 格式：逗号分隔，如 pekko://datapillar-job@node1:2551,pekko://datapillar-job@node2:2551
  seed-nodes: pekko://datapillar-job@127.0.0.1:2551

# -----------------------------------------------------------------------------
# 日志配置
# -----------------------------------------------------------------------------
logging:
  # 日志级别：DEBUG, INFO, WARN, ERROR
  level: INFO
  # 日志输出目录
  path: ../logs
