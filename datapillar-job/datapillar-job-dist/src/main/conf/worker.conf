# =============================================================================
# Pekko Cluster 配置
# =============================================================================
# 去中心化 + 本地化架构：
# - 每个 Worker 有一个本地 JobScheduler
# - 通过 CRDT (Bucket) 实现任务分片
# - 任务在 Virtual Thread Dispatcher 执行
#
# @author SunnyX6
# @date 2025-12-14
# =============================================================================

pekko {
  loglevel = "INFO"
  loglevel = ${?PEKKO_LOG_LEVEL}

  loggers = ["org.apache.pekko.event.slf4j.Slf4jLogger"]
  logging-filter = "org.apache.pekko.event.slf4j.Slf4jLoggingFilter"

  actor {
    provider = "cluster"

    # Protobuf 序列化配置
    serializers {
      scheduler-message-serializer = "com.sunny.job.worker.pekko.serializer.SchedulerMessageSerializer"
      executor-message-serializer = "com.sunny.job.worker.pekko.serializer.ExecutorMessageSerializer"
      job-run-info-serializer = "com.sunny.job.worker.pekko.serializer.JobRunInfoSerializer"
    }

    serialization-bindings {
      "com.sunny.job.core.message.SchedulerMessage" = scheduler-message-serializer
      "com.sunny.job.core.message.ExecutorMessage" = executor-message-serializer
      "com.sunny.job.core.message.JobRunInfo" = job-run-info-serializer
    }

    # JobScheduler Dispatcher - Fork-Join（调度决策，轻量操作）
    job-scheduler-dispatcher {
      type = Dispatcher
      executor = "fork-join-executor"
      fork-join-executor {
        parallelism-min = 2
        parallelism-factor = 1.0
        parallelism-max = 16
      }
      throughput = 100
    }

    # JobExecutor Dispatcher - Virtual Thread（任务执行，可阻塞）
    job-executor-dispatcher {
      type = VirtualThreadExecutor
    }
  }

  remote {
    artery {
      canonical {
        # 绑定地址（从环境变量或配置文件读取）
        hostname = "127.0.0.1"
        hostname = ${?PEKKO_HOST}
        port = 2551
        port = ${?PEKKO_PORT}
      }

      # 生产环境优化
      advanced {
        # 最大帧大小（大消息传输）
        maximum-frame-size = 2 MiB
        # 发送缓冲区
        send-buffer-size = 2 MiB
        # 接收缓冲区
        receive-buffer-size = 2 MiB
        # 压缩大消息
        compression {
          actor-refs.advertisement-interval = 30s
          manifests.advertisement-interval = 30s
        }
      }
    }
  }

  cluster {
    # 种子节点（从环境变量读取，支持逗号分隔多个）
    seed-nodes = ["pekko://datapillar-job@127.0.0.1:2551"]
    seed-nodes = ${?PEKKO_SEED_NODES}

    # Split Brain Resolver（脑裂处理）
    downing-provider-class = "org.apache.pekko.cluster.sbr.SplitBrainResolverProvider"

    split-brain-resolver {
      # 策略：keep-majority（保留多数派）
      active-strategy = keep-majority
      # 稳定时间（节点状态稳定后才做决策）
      stable-after = 20s
    }

    # 故障检测
    failure-detector {
      # 心跳间隔
      heartbeat-interval = 1s
      # 可接受的心跳暂停时间
      acceptable-heartbeat-pause = 5s
      # 故障检测阈值
      threshold = 8.0
    }
  }

  # Distributed Data 配置（CRDT 状态同步）
  cluster.distributed-data {
    # Gossip 间隔（状态同步频率）
    gossip-interval = 500ms
    # 订阅者通知间隔
    notify-subscribers-interval = 200ms
    # 每次 gossip 最大元素数
    max-delta-elements = 500
    # 持久化配置
    durable {
      keys = []
      lmdb {
        dir = ""
        map-size = 100 MiB
      }
    }
  }
}
