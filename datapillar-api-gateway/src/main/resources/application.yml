server:
  port: 6000

spring:
  application:
    name: datapillar-api-gateway

  cloud:
    gateway:
      server:
        webflux:
          # 全局 CORS 配置
          globalcors:
            cors-configurations:
              '[/**]':
                allowedOriginPatterns: "*"
                allowedMethods:
                  - GET
                  - POST
                  - PUT
                  - DELETE
                  - OPTIONS
                allowedHeaders: "*"
                allowCredentials: true
                maxAge: 3600

          # 默认过滤器
          default-filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
                deny-empty-key: false

          # 路由配置
          routes:
            # 1. 认证服务 (datapillar-auth)
            # 重写: /api/auth/** → /auth/**
            - id: auth-service
              uri: http://localhost:6001
              predicates:
                - Path=/api/auth/**
              filters:
                - RewritePath=/api(?<segment>/?.*), ${segment}

            # 2. 核心业务服务 (datapillar-web-admin)
            - id: webadmin-service
              uri: http://localhost:6002
              predicates:
                - Path=/api/users/**,/api/roles/**
              filters:
                - RewritePath=/api(?<segment>/?.*), ${segment}

            # 3. AI 服务 (datapillar-ai)
            - id: ai-service
              uri: http://localhost:6003
              predicates:
                - Path=/api/ai/**

            # 4. 元数据服务 (datapillar-gravitino)
            # Gravitino 原生 REST API
            # 重写: /api/metadata/** → /api/**
            - id: onemeta-service
              uri: http://localhost:8090
              predicates:
                - Path=/api/onemeta/**
              filters:
                - RewritePath=/api/onemeta(?<segment>/?.*), /api${segment}

  # Redis 配置（用于限流）
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:1}

# 网关认证配置
gateway:
  auth:
    # 认证白名单（不需要 Token 的路径）
    whitelist: >
      /api/auth/login,
      /api/auth/register,
      /api/auth/refresh,
      /api/auth/captcha,
      /actuator/**,
      /health/**

# JWT 配置（必须与 datapillar-auth 保持一致）
jwt:
  secret: ${JWT_SECRET:DatapillarJwtSecretKey123456789012345678901234567890}
  issuer: datapillar-auth

# Resilience4j 熔断配置
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 5
    instances:
      auth-service:
        baseConfig: default
      admin-service:
        baseConfig: default
      ai-service:
        baseConfig: default
        # AI 服务超时时间更长
        slowCallDurationThreshold: 30s
      job-service:
        baseConfig: default
  timelimiter:
    configs:
      default:
        timeoutDuration: 10s
    instances:
      ai-service:
        timeoutDuration: 60s

# Actuator 健康检查
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    health:
      show-details: always

logging:
  level:
    org.springframework.cloud.gateway: INFO
    reactor.netty: INFO
    com.sunny.datapillar.gateway: DEBUG
    io.netty.resolver.dns: WARN
    root: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ${LOG_HOME:/tmp/datapillar-logs}/datapillar-api-gateway.log
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 30
