<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.datapillar.studio.module.user.mapper.RoleMapper">

    <select id="findByUserId" resultType="com.sunny.datapillar.studio.module.user.entity.Role">
        SELECT r.* FROM roles r
        INNER JOIN user_roles ur ON r.id = ur.role_id
        WHERE ur.user_id = #{userId}
          AND ur.tenant_id = #{tenantId}
          AND r.tenant_id = #{tenantId}
    </select>

    <select id="findByName" resultType="com.sunny.datapillar.studio.module.user.entity.Role">
        SELECT * FROM roles
        WHERE tenant_id = #{tenantId}
          AND name = #{name}
    </select>

    <delete id="deleteRolePermissions">
        DELETE FROM role_permissions WHERE role_id = #{roleId} AND tenant_id = #{tenantId}
    </delete>

    <delete id="deleteUserRolesByRoleId">
        DELETE FROM user_roles WHERE role_id = #{roleId} AND tenant_id = #{tenantId}
    </delete>

    <insert id="insertRolePermission">
        INSERT INTO role_permissions (tenant_id, role_id, object_id, permission_id)
        VALUES (#{tenantId}, #{roleId}, #{objectId}, #{permissionId})
    </insert>

    <select id="selectRoleListWithMemberCount"
            resultType="com.sunny.datapillar.studio.module.user.dto.RoleDto$Response">
        SELECT
            r.id AS id,
            r.tenant_id AS tenantId,
            r.type AS type,
            r.name AS name,
            r.description AS description,
            r.status AS status,
            r.sort AS sort,
            r.is_builtin AS isBuiltin,
            COALESCE(ur.member_count, 0) AS memberCount
        FROM roles r
        LEFT JOIN (
            SELECT tenant_id, role_id, COUNT(1) AS member_count
            FROM user_roles
            WHERE tenant_id = #{tenantId}
            GROUP BY tenant_id, role_id
        ) ur ON ur.tenant_id = r.tenant_id AND ur.role_id = r.id
        WHERE r.tenant_id = #{tenantId}
        ORDER BY r.sort ASC, r.id ASC
    </select>

    <select id="countUsersByRoleId" resultType="long">
        SELECT COUNT(1)
        FROM user_roles
        WHERE tenant_id = #{tenantId}
          AND role_id = #{roleId}
    </select>

    <select id="selectMaxSortByTenant" resultType="int">
        SELECT COALESCE(MAX(sort), 0)
        FROM roles
        WHERE tenant_id = #{tenantId}
    </select>

    <select id="selectRoleMembers"
            resultType="com.sunny.datapillar.studio.module.user.dto.RoleDto$MemberItem">
        SELECT
            u.id AS userId,
            u.username AS username,
            u.nickname AS nickname,
            u.email AS email,
            u.phone AS phone,
            tu.status AS memberStatus,
            tu.joined_at AS joinedAt,
            ur.created_at AS assignedAt
        FROM user_roles ur
        INNER JOIN tenant_users tu
            ON tu.tenant_id = ur.tenant_id
           AND tu.user_id = ur.user_id
        INNER JOIN users u
            ON u.id = ur.user_id
        WHERE ur.tenant_id = #{tenantId}
          AND ur.role_id = #{roleId}
          <if test="status != null">
            AND tu.status = #{status}
          </if>
          AND u.deleted = 0
        ORDER BY ur.created_at DESC, ur.user_id DESC
    </select>

</mapper>
