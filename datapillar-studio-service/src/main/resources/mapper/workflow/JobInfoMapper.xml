<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.datapillar.studio.module.workflow.mapper.JobInfoMapper">

    <resultMap id="JobResponseResult" type="com.sunny.datapillar.studio.module.workflow.dto.JobDto$Response">
        <result property="id" column="id"/>
        <result property="workflowId" column="workflow_id"/>
        <result property="jobName" column="job_name"/>
        <result property="jobType" column="job_type"/>
        <result property="jobTypeCode" column="job_type_code"/>
        <result property="jobTypeName" column="job_type_name"/>
        <result property="jobParams" column="job_params" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result property="timeoutSeconds" column="timeout_seconds"/>
        <result property="maxRetryTimes" column="max_retry_times"/>
        <result property="retryInterval" column="retry_interval"/>
        <result property="priority" column="priority"/>
        <result property="positionX" column="position_x"/>
        <result property="positionY" column="position_y"/>
        <result property="description" column="description"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="selectJobsByWorkflowId" resultMap="JobResponseResult">
        SELECT j.id, j.workflow_id, j.job_name, j.job_type,
               c.component_code as job_type_code, c.component_name as job_type_name,
               j.job_params, j.timeout_seconds, j.max_retry_times, j.retry_interval,
               j.priority, j.position_x, j.position_y, j.description,
               j.created_at, j.updated_at
        FROM job_info j
        LEFT JOIN job_component c ON j.job_type = c.id
        WHERE j.workflow_id = #{workflowId} AND j.is_deleted = 0
        ORDER BY j.id
    </select>

    <select id="selectJobDetail" resultMap="JobResponseResult">
        SELECT j.id, j.workflow_id, j.job_name, j.job_type,
               c.component_code as job_type_code, c.component_name as job_type_name,
               j.job_params, j.timeout_seconds, j.max_retry_times, j.retry_interval,
               j.priority, j.position_x, j.position_y, j.description,
               j.created_at, j.updated_at
        FROM job_info j
        LEFT JOIN job_component c ON j.job_type = c.id
        WHERE j.id = #{id} AND j.is_deleted = 0
    </select>

    <update id="batchUpdatePositions">
        <foreach collection="positions" item="pos" separator=";">
            UPDATE job_info
            SET position_x = #{pos.positionX}, position_y = #{pos.positionY}
            WHERE id = #{pos.jobId} AND is_deleted = 0
        </foreach>
    </update>

    <update id="deleteByWorkflowId">
        UPDATE job_info SET is_deleted = 1
        WHERE workflow_id = #{workflowId} AND is_deleted = 0
    </update>

</mapper>
