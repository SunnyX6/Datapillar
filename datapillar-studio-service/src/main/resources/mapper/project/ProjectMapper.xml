<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.datapillar.studio.module.project.mapper.ProjectMapper">

    <resultMap id="ResponseResult" type="com.sunny.datapillar.studio.module.project.dto.ProjectDto$Response">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="description" column="description"/>
        <result property="ownerId" column="owner_id"/>
        <result property="ownerName" column="owner_name"/>
        <result property="status" column="status"/>
        <result property="isFavorite" column="is_favorite"/>
        <result property="isVisible" column="is_visible"/>
        <result property="memberCount" column="member_count"/>
        <result property="lastAccessedAt" column="last_accessed_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="selectProjectPage" resultMap="ResponseResult">
        SELECT p.id, p.name, p.description, p.owner_id, u.username as owner_name,
               p.status, p.tags, p.is_favorite, p.is_visible, p.member_count,
               p.last_accessed_at, p.created_at, p.updated_at
        FROM projects p
        LEFT JOIN users u ON p.owner_id = u.id
        WHERE p.deleted = false
        ORDER BY p.updated_at DESC
    </select>

    <select id="selectMyProjects" resultMap="ResponseResult">
        SELECT p.id, p.name, p.description, p.owner_id, u.username as owner_name,
               p.status, p.tags, p.is_favorite, p.is_visible, p.member_count,
               p.last_accessed_at, p.created_at, p.updated_at
        FROM projects p
        LEFT JOIN users u ON p.owner_id = u.id
        WHERE p.deleted = false
          AND (#{isAdmin} = true OR p.owner_id = #{userId})
        ORDER BY p.updated_at DESC
    </select>

    <select id="selectProjectById" resultMap="ResponseResult">
        SELECT p.id, p.name, p.description, p.owner_id, u.username as owner_name,
               p.status, p.tags, p.is_favorite, p.is_visible, p.member_count,
               p.last_accessed_at, p.created_at, p.updated_at
        FROM projects p
        LEFT JOIN users u ON p.owner_id = u.id
        WHERE p.id = #{id} AND p.deleted = false
    </select>

</mapper>
