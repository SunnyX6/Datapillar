<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.datapillar.auth.mapper.UserMapper">

    <resultMap id="UserResult" type="com.sunny.datapillar.auth.entity.User">
        <result property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="passwordHash" column="password"/>
        <result property="email" column="email"/>
        <result property="status" column="status"/>
        <result property="tokenSign" column="token_sign"/>
        <result property="tokenExpireTime" column="token_expire_time"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="selectByUsername" resultMap="UserResult">
        SELECT id, username, password, email, status, token_sign, token_expire_time, created_at, updated_at
        FROM users
        WHERE username = #{username}
    </select>

    <select id="selectByEmail" resultMap="UserResult">
        SELECT id, username, password, email, status, token_sign, token_expire_time, created_at, updated_at
        FROM users
        WHERE email = #{email}
    </select>

    <update id="updateTokenSign">
        UPDATE users SET token_sign = #{tokenSign}, token_expire_time = #{expireTime}
        WHERE id = #{userId}
    </update>

    <select id="selectByIdAndTokenSign" resultMap="UserResult">
        SELECT id, username, password, email, status, token_sign, token_expire_time, created_at, updated_at
        FROM users
        WHERE id = #{userId} AND token_sign = #{tokenSign}
    </select>

    <update id="clearTokenSign">
        UPDATE users SET token_sign = NULL, token_expire_time = NULL
        WHERE id = #{userId}
    </update>

    <select id="selectRoleCodesByUserId" resultType="string">
        SELECT r.code FROM roles r
        INNER JOIN user_roles ur ON r.id = ur.role_id
        WHERE ur.user_id = #{userId}
    </select>

    <select id="selectPermissionCodesByUserId" resultType="string">
        SELECT DISTINCT p.code FROM permissions p
        INNER JOIN role_permissions rp ON p.id = rp.permission_id
        INNER JOIN user_roles ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = #{userId}
    </select>

    <select id="selectMenusByUserId" resultType="map">
        SELECT DISTINCT m.id, m.name, m.path, m.icon, m.permission_code, m.parent_id, m.sort
        FROM menus m
        LEFT JOIN menu_roles mr ON m.id = mr.menu_id
        LEFT JOIN user_roles ur ON mr.role_id = ur.role_id
        WHERE (ur.user_id = #{userId} OR m.permission_code IS NULL)
          AND m.visible = 1
        ORDER BY m.sort ASC
    </select>

</mapper>
