<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.datapillar.auth.mapper.UserMapper">

    <resultMap id="UserResult" type="com.sunny.datapillar.auth.entity.User">
        <result property="id" column="id"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="username" column="username"/>
        <result property="passwordHash" column="password"/>
        <result property="email" column="email"/>
        <result property="phone" column="phone"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="selectByUsername" resultMap="UserResult">
        SELECT id, tenant_id, username, password, email, phone, status, created_at, updated_at
        FROM users
        WHERE username = #{username}
    </select>

    <select id="selectByEmail" resultMap="UserResult">
        SELECT id, tenant_id, username, password, email, phone, status, created_at, updated_at
        FROM users
        WHERE email = #{email}
    </select>

    <select id="selectRolesByUserId" resultType="com.sunny.datapillar.auth.dto.AuthDto$RoleInfo">
        SELECT r.id, r.name, r.type
        FROM roles r
        INNER JOIN user_roles ur ON r.id = ur.role_id
        WHERE ur.tenant_id = #{tenantId}
          AND r.tenant_id = #{tenantId}
          AND ur.user_id = #{userId}
        ORDER BY r.sort ASC, r.id ASC
    </select>

    <select id="selectMenusByUserId" resultType="map">
        SELECT
            o.id,
            o.name,
            o.path,
            o.parent_id,
            o.location,
            CASE WHEN o.location = 'SIDEBAR' THEN o.category_id ELSE NULL END AS category_id,
            CASE WHEN o.location = 'SIDEBAR' THEN c.name ELSE NULL END AS category_name,
            o.sort,
            CASE
                WHEN LEAST(
                    MAX(CASE p.code WHEN 'ADMIN' THEN 3 WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END),
                    MAX(CASE tp.code WHEN 'ADMIN' THEN 3 WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END)
                ) >= 3 THEN 'ADMIN'
                WHEN LEAST(
                    MAX(CASE p.code WHEN 'ADMIN' THEN 3 WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END),
                    MAX(CASE tp.code WHEN 'ADMIN' THEN 3 WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END)
                ) >= 2 THEN 'WRITE'
                WHEN LEAST(
                    MAX(CASE p.code WHEN 'ADMIN' THEN 3 WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END),
                    MAX(CASE tp.code WHEN 'ADMIN' THEN 3 WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END)
                ) >= 1 THEN 'READ'
                ELSE 'NONE'
            END AS permission_code
        FROM feature_objects o
        LEFT JOIN feature_object_categories c ON o.category_id = c.id
        INNER JOIN tenant_feature_permissions tfe
                ON tfe.object_id = o.id
               AND tfe.tenant_id = #{tenantId}
               AND tfe.status = 1
        INNER JOIN permissions tp ON tp.id = tfe.permission_id
        INNER JOIN (
            SELECT rp.object_id, rp.permission_id
            FROM role_permissions rp
            INNER JOIN user_roles ur ON ur.role_id = rp.role_id
            WHERE ur.tenant_id = #{tenantId}
              AND rp.tenant_id = #{tenantId}
              AND ur.user_id = #{userId}
            UNION ALL
            SELECT up.object_id, up.permission_id
            FROM user_permission_overrides up
            WHERE up.tenant_id = #{tenantId}
              AND up.user_id = #{userId}
        ) rel ON rel.object_id = o.id
        INNER JOIN permissions p ON p.id = rel.permission_id
        WHERE o.type = 'MENU'
          AND o.status = 1
        GROUP BY o.id, o.name, o.path, o.parent_id, o.location, o.category_id, c.name, o.sort
        ORDER BY o.sort ASC, o.id ASC
    </select>

    <select id="selectMenusByTenantId" resultType="map">
        SELECT
            o.id,
            o.name,
            o.path,
            o.parent_id,
            o.location,
            CASE WHEN o.location = 'SIDEBAR' THEN o.category_id ELSE NULL END AS category_id,
            CASE WHEN o.location = 'SIDEBAR' THEN c.name ELSE NULL END AS category_name,
            o.sort,
            tp.code AS permission_code
        FROM feature_objects o
        LEFT JOIN feature_object_categories c ON o.category_id = c.id
        INNER JOIN tenant_feature_permissions tfe
                ON tfe.object_id = o.id
               AND tfe.tenant_id = #{tenantId}
               AND tfe.status = 1
        INNER JOIN permissions tp ON tp.id = tfe.permission_id
        WHERE o.type = 'MENU'
          AND o.status = 1
        ORDER BY o.sort ASC, o.id ASC
    </select>

</mapper>
