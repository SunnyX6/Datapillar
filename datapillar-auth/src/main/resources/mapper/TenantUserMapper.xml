<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.datapillar.auth.mapper.TenantUserMapper">

    <resultMap id="TenantUserResult" type="com.sunny.datapillar.auth.entity.TenantUser">
        <result property="id" column="id"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="userId" column="user_id"/>
        <result property="status" column="status"/>
        <result property="isDefault" column="is_default"/>
        <result property="tokenSign" column="token_sign"/>
        <result property="tokenExpireTime" column="token_expire_time"/>
        <result property="joinedAt" column="joined_at"/>
    </resultMap>

    <select id="selectByTenantIdAndUserId" resultMap="TenantUserResult">
        SELECT id, tenant_id, user_id, status, is_default, token_sign, token_expire_time, joined_at
        FROM tenant_users
        WHERE tenant_id = #{tenantId} AND user_id = #{userId}
    </select>

    <update id="updateTokenSign">
        UPDATE tenant_users
        SET token_sign = #{tokenSign}, token_expire_time = #{expireTime}
        WHERE tenant_id = #{tenantId} AND user_id = #{userId}
    </update>

    <update id="clearTokenSign">
        UPDATE tenant_users
        SET token_sign = NULL, token_expire_time = NULL
        WHERE tenant_id = #{tenantId} AND user_id = #{userId}
    </update>

    <select id="countByUserId" resultType="int">
        SELECT COUNT(1)
        FROM tenant_users
        WHERE user_id = #{userId}
    </select>

    <select id="selectTenantOptionsByUserId" resultType="com.sunny.datapillar.auth.dto.AuthDto$TenantOption">
        SELECT t.id AS tenant_id,
               t.code AS tenant_code,
               t.name AS tenant_name,
               t.status AS status,
               tu.is_default AS is_default
        FROM tenant_users tu
        INNER JOIN tenants t ON t.id = tu.tenant_id
        WHERE tu.user_id = #{userId}
          AND tu.status = 1
          AND t.status = 1
        ORDER BY tu.is_default DESC, t.id ASC
    </select>

</mapper>
