<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.datapillar.platform.module.features.mapper.FeatureObjectMapper">

    <select id="selectFeatureObjectsAll" resultType="com.sunny.datapillar.platform.module.features.dto.FeatureObjectDto$ObjectPermission">
        SELECT o.id AS object_id,
               o.name AS object_name,
               o.path AS object_path,
               o.type AS object_type,
               o.location AS location,
               o.category_id AS category_id,
               c.name AS category_name,
               tp.code AS tenant_permission_code
        FROM feature_objects o
        LEFT JOIN feature_object_categories c
               ON o.category_id = c.id
              AND c.tenant_id IN (0, #{tenantId})
        INNER JOIN tenant_feature_permissions tfe
                ON tfe.object_id = o.id
               AND tfe.tenant_id = #{tenantId}
               AND tfe.status = 1
        INNER JOIN permissions tp ON tp.id = tfe.permission_id AND tp.tenant_id = 0
        WHERE o.status = 1
          AND o.tenant_id IN (0, #{tenantId})
        ORDER BY o.sort ASC, o.id ASC
    </select>

    <select id="selectRoleObjectPermissionsAll" resultType="com.sunny.datapillar.platform.module.features.dto.FeatureObjectDto$ObjectPermission">
        SELECT o.id AS object_id,
               o.name AS object_name,
               o.path AS object_path,
               o.type AS object_type,
               o.location AS location,
               o.category_id AS category_id,
               c.name AS category_name,
               tp.code AS tenant_permission_code,
               CASE rp.permission_level
                   WHEN 3 THEN 'ADMIN'
                   WHEN 2 THEN 'WRITE'
                   WHEN 1 THEN 'READ'
                   ELSE 'NONE'
               END AS permission_code
        FROM feature_objects o
        LEFT JOIN feature_object_categories c
               ON o.category_id = c.id
              AND c.tenant_id IN (0, #{tenantId})
        INNER JOIN tenant_feature_permissions tfe
                ON tfe.object_id = o.id
               AND tfe.tenant_id = #{tenantId}
               AND tfe.status = 1
        INNER JOIN permissions tp ON tp.id = tfe.permission_id AND tp.tenant_id = 0
        LEFT JOIN (
            SELECT rp.object_id,
                   MAX(CASE p.code WHEN 'ADMIN' THEN 3 WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END) AS permission_level
            FROM role_permissions rp
            INNER JOIN permissions p ON p.id = rp.permission_id AND p.tenant_id = 0
            WHERE rp.role_id = #{roleId}
              AND rp.tenant_id = #{tenantId}
            GROUP BY rp.object_id
        ) rp ON rp.object_id = o.id
        WHERE o.status = 1
          AND o.tenant_id IN (0, #{tenantId})
        ORDER BY o.sort ASC, o.id ASC
    </select>

    <select id="selectRoleObjectPermissionsAssigned" resultType="com.sunny.datapillar.platform.module.features.dto.FeatureObjectDto$ObjectPermission">
        SELECT o.id AS object_id,
               o.name AS object_name,
               o.path AS object_path,
               o.type AS object_type,
               o.location AS location,
               o.category_id AS category_id,
               c.name AS category_name,
               tp.code AS tenant_permission_code,
               CASE rp.permission_level
                   WHEN 3 THEN 'ADMIN'
                   WHEN 2 THEN 'WRITE'
                   WHEN 1 THEN 'READ'
                   ELSE 'NONE'
               END AS permission_code
        FROM feature_objects o
        LEFT JOIN feature_object_categories c
               ON o.category_id = c.id
              AND c.tenant_id IN (0, #{tenantId})
        INNER JOIN tenant_feature_permissions tfe
                ON tfe.object_id = o.id
               AND tfe.tenant_id = #{tenantId}
               AND tfe.status = 1
        INNER JOIN permissions tp ON tp.id = tfe.permission_id AND tp.tenant_id = 0
        INNER JOIN (
            SELECT rp.object_id,
                   MAX(CASE p.code WHEN 'ADMIN' THEN 3 WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END) AS permission_level
            FROM role_permissions rp
            INNER JOIN permissions p ON p.id = rp.permission_id AND p.tenant_id = 0
            WHERE rp.role_id = #{roleId}
              AND rp.tenant_id = #{tenantId}
            GROUP BY rp.object_id
        ) rp ON rp.object_id = o.id
        WHERE o.status = 1
          AND o.tenant_id IN (0, #{tenantId})
        ORDER BY o.sort ASC, o.id ASC
    </select>

    <select id="selectUserRoleSources" resultType="com.sunny.datapillar.platform.module.features.dto.FeatureObjectDto$RoleSource">
        SELECT rp.object_id AS object_id,
               r.id AS role_id,
               r.name AS role_name,
               CASE MAX(CASE p.code WHEN 'ADMIN' THEN 3 WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END)
                   WHEN 3 THEN 'ADMIN'
                   WHEN 2 THEN 'WRITE'
                   WHEN 1 THEN 'READ'
                   ELSE 'NONE'
               END AS permission_code
        FROM role_permissions rp
        INNER JOIN permissions p ON p.id = rp.permission_id AND p.tenant_id = 0
        INNER JOIN roles r ON r.id = rp.role_id
        INNER JOIN user_roles ur ON ur.role_id = rp.role_id
        WHERE ur.user_id = #{userId}
          AND ur.tenant_id = #{tenantId}
          AND rp.tenant_id = #{tenantId}
          AND r.tenant_id = #{tenantId}
        GROUP BY rp.object_id, r.id, r.name
    </select>

    <select id="selectUserOverridePermissions" resultType="com.sunny.datapillar.platform.module.features.dto.FeatureObjectDto$Assignment">
        SELECT up.object_id AS object_id,
               CASE MAX(CASE p.code WHEN 'ADMIN' THEN 3 WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END)
                   WHEN 3 THEN 'ADMIN'
                   WHEN 2 THEN 'WRITE'
                   WHEN 1 THEN 'READ'
                   ELSE 'NONE'
               END AS permission_code
        FROM user_permission_overrides up
        INNER JOIN permissions p ON p.id = up.permission_id AND p.tenant_id = 0
        WHERE up.user_id = #{userId}
          AND up.tenant_id = #{tenantId}
        GROUP BY up.object_id
    </select>

    <select id="findByUserId" resultType="com.sunny.datapillar.platform.module.features.entity.FeatureObject">
        SELECT DISTINCT o.*, c.name AS category_name
        FROM feature_objects o
        LEFT JOIN feature_object_categories c
               ON o.category_id = c.id
              AND c.tenant_id IN (0, #{tenantId})
        INNER JOIN tenant_feature_permissions tfe
                ON tfe.object_id = o.id
               AND tfe.tenant_id = #{tenantId}
               AND tfe.status = 1
        WHERE o.type = 'MENU'
          AND o.status = 1
          AND o.tenant_id IN (0, #{tenantId})
          AND (#{location} IS NULL OR #{location} = '' OR o.location = #{location})
          AND o.id IN (
                SELECT rp.object_id
                FROM role_permissions rp
                INNER JOIN user_roles ur ON ur.role_id = rp.role_id
                WHERE ur.user_id = #{userId}
                  AND ur.tenant_id = #{tenantId}
                  AND rp.tenant_id = #{tenantId}
                UNION
                SELECT up.object_id
                FROM user_permission_overrides up
                WHERE up.user_id = #{userId}
                  AND up.tenant_id = #{tenantId}
          )
        ORDER BY o.sort ASC, o.id ASC
    </select>

    <select id="findAllVisible" resultType="com.sunny.datapillar.platform.module.features.entity.FeatureObject">
        SELECT o.*, c.name AS category_name
        FROM feature_objects o
        LEFT JOIN feature_object_categories c
               ON o.category_id = c.id
              AND c.tenant_id IN (0, #{tenantId})
        INNER JOIN tenant_feature_permissions tfe
                ON tfe.object_id = o.id
               AND tfe.tenant_id = #{tenantId}
               AND tfe.status = 1
        WHERE o.type = 'MENU'
          AND o.status = 1
          AND o.tenant_id IN (0, #{tenantId})
        ORDER BY o.sort ASC, o.id ASC
    </select>

    <select id="selectFeatureEntitlements" resultType="com.sunny.datapillar.platform.module.features.dto.FeatureEntitlementDto$Item">
        SELECT o.id AS object_id,
               o.name AS object_name,
               o.path AS object_path,
               o.type AS object_type,
               o.location AS location,
               o.category_id AS category_id,
               c.name AS category_name,
               o.sort AS sort,
               o.status AS object_status,
               tfe.status AS entitlement_status,
               p.code AS permission_code,
               p.level AS permission_level
        FROM feature_objects o
        LEFT JOIN feature_object_categories c
               ON o.category_id = c.id
              AND c.tenant_id IN (0, #{tenantId})
        LEFT JOIN tenant_feature_permissions tfe
               ON tfe.object_id = o.id
              AND tfe.tenant_id = #{tenantId}
        LEFT JOIN permissions p ON p.id = tfe.permission_id AND p.tenant_id = 0
        WHERE o.status = 1
          AND o.tenant_id IN (0, #{tenantId})
        ORDER BY o.sort ASC, o.id ASC
    </select>

    <select id="selectFeatureEntitlement" resultType="com.sunny.datapillar.platform.module.features.dto.FeatureEntitlementDto$Item">
        SELECT o.id AS object_id,
               o.name AS object_name,
               o.path AS object_path,
               o.type AS object_type,
               o.location AS location,
               o.category_id AS category_id,
               c.name AS category_name,
               o.sort AS sort,
               o.status AS object_status,
               tfe.status AS entitlement_status,
               p.code AS permission_code,
               p.level AS permission_level
        FROM feature_objects o
        LEFT JOIN feature_object_categories c
               ON o.category_id = c.id
              AND c.tenant_id IN (0, #{tenantId})
        LEFT JOIN tenant_feature_permissions tfe
               ON tfe.object_id = o.id
              AND tfe.tenant_id = #{tenantId}
        LEFT JOIN permissions p ON p.id = tfe.permission_id AND p.tenant_id = 0
        WHERE o.id = #{objectId}
          AND o.status = 1
          AND o.tenant_id IN (0, #{tenantId})
        LIMIT 1
    </select>

</mapper>
