# -*- coding: utf-8 -*-
"""
{{ dag_id }}

Auto-generated by Datapillar Airflow Plugin
DO NOT EDIT MANUALLY - Changes will be overwritten
"""

from datetime import datetime, timedelta
from airflow import DAG
from airflow.operators.python import PythonOperator

from datapillar_airflow_plugin.executor import execute_component


# Default arguments
default_args = {
    'owner': '{{ config.get("owner", "datapillar") }}',
    'depends_on_past': False,
    'start_date': datetime(2024, 1, 1),
    'retries': {{ config.get("retries", 1) }},
    'retry_delay': timedelta(minutes={{ config.get("retry_delay_minutes", 5) }}),
    'email_on_failure': False,
    'email_on_retry': False,
}


with DAG(
    dag_id='{{ dag_id }}',
    default_args=default_args,
    description='{{ config.get("description", "") | default("Generated by Datapillar", true) }}',
    schedule_interval={{ ("'" + config.get("schedule") + "'") if config.get("schedule") else "None" }},
    catchup=False,
    max_active_runs=1,
    tags=['datapillar'],
) as dag:

    # Task dictionary for dependency setup
    tasks = {}

{% for node in config.get("nodes", []) %}
    # Task: {{ node.get("name", node.get("id")) }}
    tasks['{{ node.get("id") }}'] = PythonOperator(
        task_id='{{ node.get("id") }}',
        python_callable=execute_component,
        op_kwargs={
            'component_code': '{{ node.get("type", "SHELL") }}',
            'params': {{ node.get("params", {}) | tojson }},
        },
{% if node.get("timeout") %}
        execution_timeout=timedelta(seconds={{ node.get("timeout") }}),
{% endif %}
{% if node.get("retries") is not none %}
        retries={{ node.get("retries") }},
{% endif %}
    )

{% endfor %}

    # Dependencies
{% for edge in config.get("edges", []) %}
    tasks['{{ edge.get("source") }}'] >> tasks['{{ edge.get("target") }}']
{% endfor %}
