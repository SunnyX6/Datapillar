# -*- coding: utf-8 -*-
"""
{{ dag_id }}

Auto-generated by Datapillar Airflow Plugin
DO NOT EDIT MANUALLY - Changes will be overwritten
"""

from datetime import datetime, timedelta
from airflow import DAG
from airflow.providers.standard.operators.python import PythonOperator

from datapillar_airflow_plugin.executor import execute_component


# Default arguments
default_args = {
    'owner': 'datapillar',
    'depends_on_past': False,
    'start_date': datetime(2024, 1, 1),
    'retries': {{ config.get("max_retry_times", 0) }},
    'retry_delay': timedelta(minutes=5),
    'email_on_failure': False,
    'email_on_retry': False,
{% if config.get("priority") %}
    'priority_weight': {{ config.get("priority") }},
{% endif %}
}

{% set trigger_type = config.get("trigger_type", 4) %}
{% set trigger_value = config.get("trigger_value", "") %}
{% if trigger_type == 1 and trigger_value %}
{% set schedule = "'" + trigger_value + "'" %}
{% elif trigger_type == 2 and trigger_value %}
{% set schedule = "timedelta(seconds=" + trigger_value + ")" %}
{% else %}
{% set schedule = "None" %}
{% endif %}

with DAG(
    dag_id='{{ dag_id }}',
    default_args=default_args,
    description='{{ config.get("description", "") | default("Generated by Datapillar", true) }}',
    schedule={{ schedule }},
    catchup=False,
    max_active_runs=1,
{% if config.get("timeout_seconds") %}
    dagrun_timeout=timedelta(seconds={{ config.get("timeout_seconds") }}),
{% endif %}
    tags=['datapillar'],
) as dag:

    # Task dictionary for dependency setup
    tasks = {}

{% for job in config.get("jobs", []) %}
    # Task: {{ job.get("job_name") }}
    tasks['{{ job.get("id") }}'] = PythonOperator(
        task_id='{{ job.get("job_name") }}',
        python_callable=execute_component,
        op_kwargs={
            'component_code': '{{ job.get("job_type", "SHELL") }}',
            'params': {{ job.get("job_params", {}) | tojson }},
        },
{% if job.get("timeout_seconds") %}
        execution_timeout=timedelta(seconds={{ job.get("timeout_seconds") }}),
{% endif %}
{% if job.get("max_retry_times") %}
        retries={{ job.get("max_retry_times") }},
{% endif %}
{% if job.get("priority") %}
        priority_weight={{ job.get("priority") }},
{% endif %}
    )

{% endfor %}

    # Dependencies
{% for dep in config.get("dependencies", []) %}
    tasks['{{ dep.get("parent_job_id") }}'] >> tasks['{{ dep.get("job_id") }}']
{% endfor %}
