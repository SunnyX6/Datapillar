<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunny.datapillar.admin.module.user.mapper.PermissionObjectMapper">

    <select id="selectPermissionObjectsAll" resultType="com.sunny.datapillar.admin.module.user.dto.PermissionObjectDto$ObjectPermission">
        SELECT o.id AS object_id,
               o.name AS object_name,
               o.path AS object_path,
               o.type AS object_type,
               o.location AS location,
               o.category_id AS category_id,
               c.name AS category_name
        FROM permission_objects o
        LEFT JOIN permission_object_categories c ON o.category_id = c.id
        WHERE o.status = 1
        ORDER BY o.sort ASC, o.id ASC
    </select>

    <select id="selectRoleObjectPermissionsAll" resultType="com.sunny.datapillar.admin.module.user.dto.PermissionObjectDto$ObjectPermission">
        SELECT o.id AS object_id,
               o.name AS object_name,
               o.path AS object_path,
               o.type AS object_type,
               o.location AS location,
               o.category_id AS category_id,
               c.name AS category_name,
               CASE rp.permission_level
                   WHEN 2 THEN 'WRITE'
                   WHEN 1 THEN 'READ'
                   ELSE 'NONE'
               END AS permission_code
        FROM permission_objects o
        LEFT JOIN permission_object_categories c ON o.category_id = c.id
        LEFT JOIN (
            SELECT rp.object_id,
                   MAX(CASE p.code WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END) AS permission_level
            FROM role_permissions rp
            INNER JOIN permissions p ON p.id = rp.permission_id
            WHERE rp.role_id = #{roleId}
            GROUP BY rp.object_id
        ) rp ON rp.object_id = o.id
        WHERE o.status = 1
        ORDER BY o.sort ASC, o.id ASC
    </select>

    <select id="selectRoleObjectPermissionsAssigned" resultType="com.sunny.datapillar.admin.module.user.dto.PermissionObjectDto$ObjectPermission">
        SELECT o.id AS object_id,
               o.name AS object_name,
               o.path AS object_path,
               o.type AS object_type,
               o.location AS location,
               o.category_id AS category_id,
               c.name AS category_name,
               CASE rp.permission_level
                   WHEN 2 THEN 'WRITE'
                   WHEN 1 THEN 'READ'
                   ELSE 'NONE'
               END AS permission_code
        FROM permission_objects o
        LEFT JOIN permission_object_categories c ON o.category_id = c.id
        INNER JOIN (
            SELECT rp.object_id,
                   MAX(CASE p.code WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END) AS permission_level
            FROM role_permissions rp
            INNER JOIN permissions p ON p.id = rp.permission_id
            WHERE rp.role_id = #{roleId}
            GROUP BY rp.object_id
        ) rp ON rp.object_id = o.id
        WHERE o.status = 1
        ORDER BY o.sort ASC, o.id ASC
    </select>

    <select id="selectUserRoleSources" resultType="com.sunny.datapillar.admin.module.user.dto.PermissionObjectDto$RoleSource">
        SELECT rp.object_id AS object_id,
               r.id AS role_id,
               r.name AS role_name,
               CASE MAX(CASE p.code WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END)
                   WHEN 2 THEN 'WRITE'
                   WHEN 1 THEN 'READ'
                   ELSE 'NONE'
               END AS permission_code
        FROM role_permissions rp
        INNER JOIN permissions p ON p.id = rp.permission_id
        INNER JOIN roles r ON r.id = rp.role_id
        INNER JOIN user_roles ur ON ur.role_id = rp.role_id
        WHERE ur.user_id = #{userId}
        GROUP BY rp.object_id, r.id, r.name
    </select>

    <select id="selectUserOverridePermissions" resultType="com.sunny.datapillar.admin.module.user.dto.PermissionObjectDto$Assignment">
        SELECT up.object_id AS object_id,
               CASE MAX(CASE p.code WHEN 'WRITE' THEN 2 WHEN 'READ' THEN 1 ELSE 0 END)
                   WHEN 2 THEN 'WRITE'
                   WHEN 1 THEN 'READ'
                   ELSE 'NONE'
               END AS permission_code
        FROM user_permission_overrides up
        INNER JOIN permissions p ON p.id = up.permission_id
        WHERE up.user_id = #{userId}
        GROUP BY up.object_id
    </select>

</mapper>
