server:
  port: 7000
  address: ${SERVER_ADDRESS:0.0.0.0}
  forward-headers-strategy: framework

spring:
  application:
    name: datapillar-api-gateway

  cloud:
    gateway:
      server:
        webflux:
          # 全局 CORS 配置
          globalcors:
            cors-configurations:
              '[/**]':
                allowedOriginPatterns:
                  - http://localhost:3001
                  - http://127.0.0.1:3001
                  - https://localhost:3001
                  - https://127.0.0.1:3001
                  - https://localhost
                  - https://127.0.0.1
                allowedMethods:
                  - GET
                  - POST
                  - PATCH
                  - PUT
                  - DELETE
                  - OPTIONS
                allowedHeaders: "*"
                allowCredentials: true
                maxAge: 3600

          # 默认过滤器
          default-filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
                deny-empty-key: false

          # 路由配置（全部走服务发现）
          routes:
            # 1. 登录服务 (datapillar-auth)
            # 重写: /api/login/** → /login/**
            - id: login-service
              uri: lb://datapillar-auth
              predicates:
                - Path=/api/login/**
              filters:
                - RewritePath=/api/login(?<segment>/?.*), /login${segment}

            # 2. 认证服务 OpenAPI 文档 (datapillar-auth)
            # 重写: /api/auth/v3/api-docs/** → /v3/api-docs/**
            - id: auth-docs
              uri: lb://datapillar-auth
              order: -10
              predicates:
                - Path=/api/auth/v3/api-docs,/api/auth/v3/api-docs/**
              filters:
                - RewritePath=/api/auth/v3/api-docs(?<segment>/?.*), /v3/api-docs${segment}

            # 3. 认证服务 (datapillar-auth)
            # 重写: /api/auth/** → /auth/**
            - id: auth-service
              uri: lb://datapillar-auth
              predicates:
                - Path=/api/auth/**
              filters:
                - RewritePath=/api(?<segment>/?.*), ${segment}

            # 4. Studio OpenAPI 文档
            - id: studio-docs
              uri: lb://datapillar-studio-service
              order: -10
              predicates:
                - Path=/api/studio/v3/api-docs,/api/studio/v3/api-docs/**

            # 5. Studio 初始化接口（初始化前无需登录）
            - id: studio-setup
              uri: lb://datapillar-studio-service
              predicates:
                - Path=/api/studio/setup,/api/studio/setup/**

            # 6. Studio 健康检查接口（无需登录）
            - id: studio-health
              uri: lb://datapillar-studio-service
              order: -10
              predicates:
                - Path=/api/studio/actuator/health,/api/studio/actuator/health/**

            # 7. Studio 业务接口（受保护）
            - id: studio-service
              uri: lb://datapillar-studio-service
              predicates:
                - Path=/api/studio/**

            # 8. AI 业务接口（受保护）
            - id: ai-service
              uri: lb://datapillar-ai
              predicates:
                - Path=/api/ai/**

            # 9. OneMeta 接口（受保护）
            - id: onemeta-service
              uri: lb://datapillar-gravitino
              predicates:
                - Path=/api/onemeta/**
              filters:
                - RewritePath=/api/onemeta(?<segment>/?.*), /api${segment}

  # Redis 配置（用于限流）
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:1}

scalar:
  enabled: true
  path: /api/docs
  operation-title-source: path
  sources:
    - title: Auth API
      url: /api/auth/v3/api-docs
      default: true
    - title: Studio API
      url: /api/studio/v3/api-docs
    - title: AI API
      url: /api/ai/openapi.json

# 安全配置（严格模式）
security:
  require-https: false
  trusted-proxies:
    - 127.0.0.1/32
    - ::1/128
  authentication:
    enabled: true
    protocol-version: security.v1
    auth-token-cookie-name: auth-token
    protected-path-prefixes:
      - /api/studio
      - /api/ai
      - /api/onemeta
    public-path-prefixes:
      - /api/login
      - /api/auth
      - /api/studio/setup
      - /api/studio/actuator/health
      - /api/studio/v3/api-docs
      - /api/ai/openapi.json
      - /api/docs
  headers:
    enabled: true
    hsts-max-age-seconds: 31536000
    include-sub-domains: true

datapillar:
  rpc:
    group: ${DUBBO_GROUP:datapillar}
    version: ${DUBBO_VERSION:1.0.0}

dubbo:
  application:
    name: datapillar-api-gateway
    qos-enable: ${DUBBO_QOS_ENABLE:false}
    register-mode: interface
    migration:
      step: FORCE_INTERFACE
    service-discovery:
      migration: FORCE_INTERFACE
  protocol:
    name: tri
    port: -1
  registry:
    address: nacos://${NACOS_SERVER_ADDR}
    group: ${NACOS_GROUP:DATAPILLAR}
    register-mode: interface
    parameters:
      namespace: ${NACOS_NAMESPACE}
      username: ${NACOS_USERNAME}
      password: ${NACOS_PASSWORD}
  consumer:
    check: ${DUBBO_CONSUMER_CHECK:false}
    timeout: ${DUBBO_CONSUMER_TIMEOUT:3000}
    parameters:
      migration.step: FORCE_INTERFACE

# Resilience4j 熔断配置
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 5
    instances:
      auth-service:
        baseConfig: default
      studio-service:
        baseConfig: default
      ai-service:
        baseConfig: default
        # AI 服务超时时间更长
        slowCallDurationThreshold: 30s
      job-service:
        baseConfig: default
  timelimiter:
    configs:
      default:
        timeoutDuration: 10s
    instances:
      ai-service:
        timeoutDuration: 60s

# Actuator 健康检查（与服务同端口）
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      probes:
        enabled: true
      show-details: never
  health:
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true

logging:
  level:
    org.springframework.cloud.gateway: INFO
    reactor.netty: INFO
    com.sunny.datapillar.gateway: DEBUG
    io.netty.resolver.dns: WARN
    root: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ${LOG_HOME:/tmp/datapillar-logs}/datapillar-api-gateway.log
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 30
