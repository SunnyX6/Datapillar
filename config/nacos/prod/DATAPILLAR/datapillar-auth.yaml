server:
  port: 7001
  address: ${SERVER_ADDRESS:0.0.0.0}
  servlet:
    context-path: /

spring:
  application:
    name: datapillar-auth
  datasource:
    # 使用与业务系统相同的数据库
    url: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}?useSSL=false&serverTimezone=UTC&characterEncoding=utf8&allowPublicKeyRetrieval=true
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      auto-commit: true
      idle-timeout: 30000
      pool-name: AuthHikariCP
      max-lifetime: 900000
      connection-timeout: 10000
  data:
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT}
      password: ${REDIS_PASSWORD}
      database: ${REDIS_DATABASE}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms

mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
    map-underscore-to-camel-case: true
  # 认证服务只扫描 users 表的 Mapper
  mapper-locations: classpath*:/mapper/*Mapper.xml

springdoc:
  use-fqn: true
  api-docs:
    enabled: true

# JWT 配置
jwt:
  # 对称密钥
  secret: ${JWT_SECRET}
  # Access Token 过期时间 (秒)
  # 开发环境：可通过环境变量 JWT_ACCESS_EXPIRATION=60 设置为60秒来测试自动刷新
  # 生产环境：3600秒（60分钟）
  access-token-expiration: ${JWT_ACCESS_EXPIRATION:3600}     # 60 分钟
  # Refresh Token 过期时间 (秒)
  # 未勾选记住我：7 天
  refresh-token-expiration: ${JWT_REFRESH_EXPIRATION:604800}  # 7 天
  # 勾选记住我：30 天
  refresh-token-expiration-remember: ${JWT_REFRESH_REMEMBER_EXPIRATION:2592000}  # 30 天
  # 登录选择租户临时 Token 过期时间 (秒)
  login-token-expiration: ${JWT_LOGIN_EXPIRATION:300}  # 5 分钟
  # 颁发者
  issuer: datapillar-auth

# Cookie 配置
cookie:
  secure: true

# 安全配置（严格模式）
security:
  trusted-proxies:
    - ${TRUSTED_PROXY_CIDR_1:}
  csrf:
    enabled: true
    header-name: X-CSRF-Token
    cookie-name: csrf-token
    refresh-header-name: X-Refresh-CSRF-Token
    refresh-cookie-name: refresh-csrf-token
    ttl-seconds: ${JWT_ACCESS_EXPIRATION:3600}
  login:
    enabled: true
    max-attempts: 5
    window-seconds: 600
    lock-seconds: 900
  password:
    argon2:
      salt-length: 16
      hash-length: 32
      parallelism: 1
      memory-mb: 64
      iterations: 3
  key-storage:
    type: ${KEY_STORAGE_TYPE:local}
    local:
      path: ${KEY_STORAGE_LOCAL_PATH:/data/datapillar/privkeys}
    object:
      endpoint: ${KEY_STORAGE_OBJECT_ENDPOINT:}
      bucket: ${KEY_STORAGE_OBJECT_BUCKET:}
      access-key: ${KEY_STORAGE_OBJECT_ACCESS_KEY:}
      secret-key: ${KEY_STORAGE_OBJECT_SECRET_KEY:}
      region: ${KEY_STORAGE_OBJECT_REGION:}
      prefix: ${KEY_STORAGE_OBJECT_PREFIX:privkeys}
  gateway-assertion:
    enabled: true
    header-name: X-Gateway-Assertion
    issuer: datapillar-auth
    audience: datapillar-studio-service
    ttl-seconds: 20
    key-id: ${AUTH_ASSERTION_KEY_ID}
    private-key-path: ${AUTH_ASSERTION_PRIVATE_KEY_PATH}

# SSO 配置
sso:
  state-bytes: ${SSO_STATE_BYTES:24}  # state 随机字节数（至少16）
  state-ttl-seconds: ${SSO_STATE_TTL_SECONDS:300}  # 5分钟

# Actuator 健康检查（与服务同端口）
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      probes:
        enabled: true
      show-details: never
  health:
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true

logging:
  level:
    com.sunny.datapillar.auth: INFO
    org.springframework.security: WARN
    org.mybatis: WARN
    com.zaxxer.hikari: WARN
    root: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ${LOG_HOME:/tmp/datapillar-logs}/datapillar-auth.log
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 30

datapillar:
  rpc:
    group: ${DUBBO_GROUP:datapillar}
    version: ${DUBBO_VERSION:1.0.0}

# Dubbo 配置

dubbo:
  application:
    name: datapillar-auth
    register-mode: interface
    migration:
      step: FORCE_INTERFACE
    service-discovery:
      migration: FORCE_INTERFACE
  protocol:
    name: tri
    port: -1
  registry:
    address: nacos://${NACOS_SERVER_ADDR}
    group: ${NACOS_GROUP:DATAPILLAR}
    register-mode: interface
    parameters:
      namespace: ${NACOS_NAMESPACE}
      username: ${NACOS_USERNAME}
      password: ${NACOS_PASSWORD}
