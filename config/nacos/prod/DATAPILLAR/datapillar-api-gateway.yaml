server:
  port: 7000
  forward-headers-strategy: framework

spring:
  application:
    name: datapillar-api-gateway

  cloud:
    gateway:
      server:
        webflux:
          # 全局 CORS 配置
          globalcors:
            cors-configurations:
              '[/**]':
                allowedOriginPatterns:
                  - https://REPLACE_ME
                allowedMethods:
                  - GET
                  - POST
                  - PUT
                  - DELETE
                  - OPTIONS
                allowedHeaders: "*"
                allowCredentials: true
                maxAge: 3600

          # 默认过滤器
          default-filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
                deny-empty-key: false

          # 路由配置（全部走服务发现）
          routes:
            # 1. 登录服务 (datapillar-auth)
            # 重写: /api/login/** → /login/**
            - id: login-service
              uri: lb://datapillar-auth
              predicates:
                - Path=/api/login/**
              filters:
                - RewritePath=/api/login(?<segment>/?.*), /login${segment}

            # 2. 认证服务 OpenAPI 文档 (datapillar-auth)
            # 重写: /api/auth/v3/api-docs/** → /v3/api-docs/**
            - id: auth-docs
              uri: lb://datapillar-auth
              order: -10
              predicates:
                - Path=/api/auth/v3/api-docs,/api/auth/v3/api-docs/**
              filters:
                - RewritePath=/api/auth/v3/api-docs(?<segment>/?.*), /v3/api-docs${segment}

            # 3. 认证服务 (datapillar-auth)
            # 重写: /api/auth/** → /auth/**
            - id: auth-service
              uri: lb://datapillar-auth
              predicates:
                - Path=/api/auth/**
              filters:
                - RewritePath=/api(?<segment>/?.*), ${segment}

            # 4. Studio OpenAPI 文档
            - id: studio-docs
              uri: lb://datapillar-studio-service
              order: -10
              predicates:
                - Path=/api/studio/v3/api-docs,/api/studio/v3/api-docs/**

            # 5. Studio 初始化接口（初始化前无需登录）
            - id: studio-setup
              uri: lb://datapillar-studio-service
              predicates:
                - Path=/api/studio/setup,/api/studio/setup/**

            # 6. 受保护业务接口统一交由 Auth 服务认证并转发
            - id: protected-service
              uri: lb://datapillar-auth
              predicates:
                - Path=/api/studio/**,/api/ai/**,/api/onemeta/**
              filters:
                - RewritePath=/api(?<segment>/?.*), /proxy/api${segment}

  # Redis 配置（用于限流）
  data:
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT}
      password: ${REDIS_PASSWORD}
      database: ${REDIS_DATABASE}

scalar:
  enabled: true
  path: /api/docs
  operation-title-source: path
  sources:
    - title: Auth API
      url: /api/auth/v3/api-docs
      default: true
    - title: Studio API
      url: /api/studio/v3/api-docs

# 安全配置（严格模式）
security:
  require-https: true
  trusted-proxies:
    - ${TRUSTED_PROXY_CIDR_1:}
  headers:
    enabled: true
    hsts-max-age-seconds: 31536000
    include-sub-domains: true

# Resilience4j 熔断配置
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 5
    instances:
      auth-service:
        baseConfig: default
      studio-service:
        baseConfig: default
      ai-service:
        baseConfig: default
        # AI 服务超时时间更长
        slowCallDurationThreshold: 30s
      job-service:
        baseConfig: default
  timelimiter:
    configs:
      default:
        timeoutDuration: 10s
    instances:
      ai-service:
        timeoutDuration: 60s

# Actuator 健康检查（与服务同端口）
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      probes:
        enabled: true
      show-details: never
  health:
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true

logging:
  level:
    org.springframework.cloud.gateway: INFO
    reactor.netty: INFO
    com.sunny.datapillar.gateway: DEBUG
    io.netty.resolver.dns: WARN
    root: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ${LOG_HOME:/tmp/datapillar-logs}/datapillar-api-gateway.log
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 30
